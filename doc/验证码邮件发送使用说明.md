# 验证码邮件发送功能使用说明

## 功能概述

提供了完整的验证码生成和邮件发送功能，支持多种邮箱服务商（QQ、163、Gmail 等）。

## 快速开始

### 1. 配置邮箱 SMTP

#### QQ 邮箱配置步骤

1. 登录 QQ 邮箱网页版：https://mail.qq.com
2. 点击 **设置** -> **账户**
3. 找到 **POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务**
4. 开启 **POP3/SMTP 服务** 或 **IMAP/SMTP 服务**
5. 点击 **生成授权码**，按提示发送短信
6. 保存生成的**授权码**（16位字符，这个是代码里要用的密码）

#### 163 邮箱配置步骤

1. 登录 163 邮箱：https://mail.163.com
2. 点击 **设置** -> **POP3/SMTP/IMAP**
3. 开启 **IMAP/SMTP 服务**
4. 设置**授权密码**（不是登录密码）
5. 保存授权密码

#### Gmail 配置步骤

1. 开启两步验证
2. 生成应用专用密码：https://myaccount.google.com/apppasswords
3. 选择应用和设备，生成密码

### 2. 代码配置

在应用启动时配置邮件参数：

```go
package main

import (
    "github.com/013677890/LCchat-Backend/pkg/util"
)

func main() {
    // 配置 QQ 邮箱
    util.SetEmailConfig(util.EmailConfig{
        SMTPHost:     "smtp.qq.com",
        SMTPPort:     465,
        SenderEmail:  "your_email@qq.com",      // 你的 QQ 邮箱
        SenderName:   "聊天服务器",
        AuthPassword: "your_auth_code_here",     // QQ 邮箱授权码（16位）
    })
    
    // 或者配置 163 邮箱
    util.SetEmailConfig(util.EmailConfig{
        SMTPHost:     "smtp.163.com",
        SMTPPort:     465,
        SenderEmail:  "your_email@163.com",
        SenderName:   "聊天服务器",
        AuthPassword: "your_auth_password",      // 163 授权密码
    })
    
    // 或者使用辅助函数获取常见邮箱配置
    host, port := util.GetCommonSMTPConfig("qq")  // 支持: qq, 163, 126, gmail, outlook
    util.SetEmailConfig(util.EmailConfig{
        SMTPHost:     host,
        SMTPPort:     port,
        SenderEmail:  "your_email@qq.com",
        SenderName:   "聊天服务器",
        AuthPassword: "your_auth_code",
    })
}
```

### 3. 使用验证码功能

#### 生成验证码

```go
// 生成 6 位数字验证码
code, err := util.GenerateVerifyCode(6)
if err != nil {
    log.Printf("生成验证码失败: %v", err)
    return
}
fmt.Println("验证码:", code)  // 输出: 验证码: 123456
```

#### 发送验证码邮件

```go
// 发送验证码邮件
err := util.SendVerifyCodeEmail(
    "user@example.com",  // 收件人邮箱
    code,                 // 验证码
    5,                    // 有效期 5 分钟
)
if err != nil {
    log.Printf("发送邮件失败: %v", err)
    return
}
fmt.Println("验证码邮件已发送")
```

#### 完整示例：用户注册发送验证码

```go
func SendRegisterVerifyCode(email string) error {
    // 1. 验证邮箱格式
    if !util.ValidateEmail(email) {
        return fmt.Errorf("邮箱格式不正确")
    }
    
    // 2. 生成验证码
    code, err := util.GenerateVerifyCode(6)
    if err != nil {
        return fmt.Errorf("生成验证码失败: %w", err)
    }
    
    // 3. 存储到 Redis（5分钟过期）
    ctx := context.Background()
    key := fmt.Sprintf("verify_code:%s", email)
    err = redisClient.Set(ctx, key, code, 5*time.Minute).Err()
    if err != nil {
        return fmt.Errorf("存储验证码失败: %w", err)
    }
    
    // 4. 发送邮件
    err = util.SendVerifyCodeEmail(email, code, 5)
    if err != nil {
        return fmt.Errorf("发送邮件失败: %w", err)
    }
    
    return nil
}
```

### 4. 发送自定义邮件

```go
// 发送自定义内容的邮件（支持 HTML）
body := `
<h1>欢迎注册</h1>
<p>感谢您注册我们的服务！</p>
<p>您的账号已激活，请登录使用。</p>
`

err := util.SendCustomEmail(
    "user@example.com",
    "欢迎注册",
    body,
)
```

## API 参考

### EmailConfig 结构体

```go
type EmailConfig struct {
    SMTPHost     string  // SMTP 服务器地址
    SMTPPort     int     // SMTP 端口
    SenderEmail  string  // 发件人邮箱
    SenderName   string  // 发件人名称
    AuthPassword string  // 授权码
}
```

### 核心函数

#### SetEmailConfig

设置邮件配置。

```go
func SetEmailConfig(config EmailConfig)
```

#### GenerateVerifyCode

生成指定位数的数字验证码。

```go
func GenerateVerifyCode(length int) (string, error)
```

参数：
- `length`: 验证码长度（默认 6 位）

返回：
- `string`: 生成的验证码
- `error`: 错误信息

#### SendVerifyCodeEmail

发送验证码邮件。

```go
func SendVerifyCodeEmail(toEmail, code string, expireMinutes int) error
```

参数：
- `toEmail`: 收件人邮箱
- `code`: 验证码
- `expireMinutes`: 验证码有效期（分钟）

#### SendCustomEmail

发送自定义内容的邮件。

```go
func SendCustomEmail(toEmail, subject, body string) error
```

#### ValidateEmail

简单的邮箱格式验证。

```go
func ValidateEmail(email string) bool
```

#### GetCommonSMTPConfig

获取常见邮箱的 SMTP 配置。

```go
func GetCommonSMTPConfig(provider string) (host string, port int)
```

支持的 provider：
- `qq`: QQ 邮箱
- `163`: 网易 163 邮箱
- `126`: 网易 126 邮箱
- `gmail`: Gmail
- `outlook`: Outlook/Hotmail

## 常见问题

### 1. 发送失败：535 Login Fail

**原因**：授权码错误或未开启 SMTP 服务。

**解决**：
- 确认已开启 SMTP 服务
- 检查授权码是否正确（注意不是登录密码）
- QQ 邮箱授权码是 16 位字符

### 2. 发送失败：连接超时

**原因**：网络问题或端口被封。

**解决**：
- 检查网络连接
- 尝试使用不同端口（465 或 587）
- 检查防火墙设置

### 3. 邮件进入垃圾箱

**原因**：发件人信誉不足。

**建议**：
- 优化邮件内容，避免敏感词
- 使用企业邮箱
- 考虑使用专业邮件服务商（如阿里云邮件推送）

### 4. 发送频率限制

QQ 邮箱限制：
- 每分钟约 30-50 封
- 每天约 500-1000 封（根据账号等级不同）

163 邮箱限制：
- 类似 QQ 邮箱

**建议**：
- 实现发送频率控制
- 对同一用户限制发送间隔（如 60 秒）
- 生产环境考虑使用专业服务

## 安全建议

1. **不要硬编码授权码**
   ```go
   // ❌ 不要这样做
   config.AuthPassword = "abcd1234efgh5678"
   
   // ✅ 推荐做法
   config.AuthPassword = os.Getenv("EMAIL_AUTH_PASSWORD")
   ```

2. **验证码使用**
   - 设置合理的过期时间（3-5分钟）
   - 限制同一邮箱的发送频率
   - 验证码使用后立即失效
   - 记录发送日志

3. **邮箱验证**
   - 发送前验证邮箱格式
   - 检查邮箱是否存在（可选）
   - 防止恶意发送

## 生产环境建议

对于生产环境，建议使用专业的邮件服务：

1. **阿里云邮件推送**：https://www.aliyun.com/product/directmail
2. **腾讯云邮件服务**：https://cloud.tencent.com/product/ses
3. **SendGrid**：https://sendgrid.com/
4. **Mailgun**：https://www.mailgun.com/

这些服务提供：
- 更高的发送量
- 更好的送达率
- 详细的统计报告
- 专业的技术支持
