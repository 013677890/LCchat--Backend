# P1 发送好友申请流程

**中文说明：** 展示发送好友申请前置校验：好友关系、待处理申请、双向黑名单校验，通过后创建申请并更新缓存。

## 过程讲解

1. 入口阶段：请求先进入图中的入口组件（客户端、Gateway 或 Connect），完成基础参数与上下文准备。
2. 核心处理：中间组件按时序执行鉴权、校验、路由、批处理或状态更新，关键分支在图中用 `alt/loop` 标注。
3. 结果输出：最终将数据写入目标存储或返回调用方；异常场景通常走降级、重试或丢弃保护逻辑。

```mermaid
sequenceDiagram
    participant C as Client
    participant G as Gateway
    participant F as User.FriendService
    participant FR as FriendRepo
    participant BR as BlacklistRepo
    participant AR as ApplyRepo
    participant R as Redis(apply pending/unread)

    C->>G: POST /friend/apply
    G->>F: SendFriendApply
    F->>FR: IsFriend?
    F->>AR: ExistsPendingRequest?
    F->>BR: peer blocked me?
    F->>BR: I blocked peer?
    F->>AR: Create apply row
    AR->>R: conditional ZADD + INCR unread
    F-->>G: apply_id
    G-->>C: success
```

