# P0 刷新令牌流程

**中文说明：** 展示 RefreshToken 链路：通过 metadata 透传上下文，校验 RefreshToken，刷新 AccessToken 并续期设备缓存。

## 过程讲解

1. 入口阶段：请求先进入图中的入口组件（客户端、Gateway 或 Connect），完成基础参数与上下文准备。
2. 核心处理：中间组件按时序执行鉴权、校验、路由、批处理或状态更新，关键分支在图中用 `alt/loop` 标注。
3. 结果输出：最终将数据写入目标存储或返回调用方；异常场景通常走降级、重试或丢弃保护逻辑。

```mermaid
sequenceDiagram
    participant C as Client
    participant G as Gateway
    participant M as gRPC Metadata
    participant U as User.AuthService
    participant R as Redis(auth:rt/auth:at)
    participant I as Redis(user:devices)

    C->>G: POST /refresh-token
    G->>M: inject trace_id/user/device
    G->>U: RefreshToken(refresh_token)
    U->>R: GET auth:rt(user,device)
    U->>U: compare refresh token
    U->>R: SET new auth:at
    U->>I: EXPIRE user:devices key
    U-->>G: new access_token
    G-->>C: RefreshTokenResponse
```

