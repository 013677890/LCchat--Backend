# P0 设备活跃心跳上报流程

**中文说明：** 展示设备保活心跳：分片节流、缓冲聚合、定时 flush、批量 gRPC 上报与 Redis ZSet 批量写入。

## 过程讲解

1. 入口阶段：请求先进入图中的入口组件（客户端、Gateway 或 Connect），完成基础参数与上下文准备。
2. 核心处理：中间组件按时序执行鉴权、校验、路由、批处理或状态更新，关键分支在图中用 `alt/loop` 标注。
3. 结果输出：最终将数据写入目标存储或返回调用方；异常场景通常走降级、重试或丢弃保护逻辑。

```mermaid
sequenceDiagram
    participant GW as Gateway/Connect
    participant SY as deviceactive.Syncer
    participant PM as PendingMap
    participant WK as SyncerWorkers
    participant U as User.DeviceService
    participant R as Redis(active zset)

    GW->>SY: Touch(user,device,now)
    SY->>SY: Shard throttle check
    alt pass interval
        SY->>PM: upsert pending item
    else throttled
        SY-->>GW: drop touch
    end

    loop every flush_interval
        SY->>PM: swap pending map
        SY->>WK: enqueue batch
        WK->>U: UpdateDeviceActive(batch)
        U->>R: ZADD + ZREMRANGEBYSCORE + EXPIRE
    end
```

