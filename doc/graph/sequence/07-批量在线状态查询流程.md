# P0 批量在线状态查询流程

**中文说明：** 展示批量在线状态查询优化：一次会话查询 + 一次批量活跃时间查询 + 一次批量 lastSeen 查询。

## 过程讲解

1. 入口阶段：请求先进入图中的入口组件（客户端、Gateway 或 Connect），完成基础参数与上下文准备。
2. 核心处理：中间组件按时序执行鉴权、校验、路由、批处理或状态更新，关键分支在图中用 `alt/loop` 标注。
3. 结果输出：最终将数据写入目标存储或返回调用方；异常场景通常走降级、重试或丢弃保护逻辑。

```mermaid
sequenceDiagram
    participant C as Client
    participant G as Gateway
    participant U as User.DeviceService
    participant S as SessionSource
    participant A as Redis(active zset)

    C->>G: POST /batch-online-status
    G->>U: BatchGetOnlineStatus(user_uuids)
    U->>S: BatchGetOnlineStatus(sessions)
    U->>A: BatchGetActiveTimestamps(user->deviceIDs)
    U->>A: BatchGetLastSeenTimestamps(user_uuids)
    U->>U: compute is_online + lastSeenAt
    U-->>G: users status list
    G-->>C: response
```

