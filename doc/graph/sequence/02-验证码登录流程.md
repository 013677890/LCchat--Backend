# P0 验证码登录流程

**中文说明：** 展示验证码登录链路：验证码校验与限流、验证码消费、Token 下发、设备会话更新与活跃时间写入。

## 过程讲解

1. 入口阶段：请求先进入图中的入口组件（客户端、Gateway 或 Connect），完成基础参数与上下文准备。
2. 核心处理：中间组件按时序执行鉴权、校验、路由、批处理或状态更新，关键分支在图中用 `alt/loop` 标注。
3. 结果输出：最终将数据写入目标存储或返回调用方；异常场景通常走降级、重试或丢弃保护逻辑。

```mermaid
sequenceDiagram
    participant C as Client
    participant G as Gateway
    participant U as User.AuthService
    participant V as Redis(verify_code + rate_limit)
    participant D as MySQL(device_session)
    participant T as Redis(token + active)

    C->>G: POST /login-by-code
    G->>U: LoginByCode(email,code,device)
    U->>V: Verify code + rate limit
    U->>V: DEL verify code
    U->>T: SET auth:at and auth:rt
    U->>D: UpsertSession(online)
    U->>T: ZADD user:devices:active
    U-->>G: token pair + user info
    G-->>C: LoginByCodeResponse
```

