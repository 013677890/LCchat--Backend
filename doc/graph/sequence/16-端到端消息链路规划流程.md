# P0 端到端消息链路规划流程

**中文说明：** 展示规划中的端到端消息链路：上行 JSON，内部 Proto，Kafka 分发，Connect 下行二进制推送。

## 过程讲解

1. 入口阶段：请求先进入图中的入口组件（客户端、Gateway 或 Connect），完成基础参数与上下文准备。
2. 核心处理：中间组件按时序执行鉴权、校验、路由、批处理或状态更新，关键分支在图中用 `alt/loop` 标注。
3. 结果输出：最终将数据写入目标存储或返回调用方；异常场景通常走降级、重试或丢弃保护逻辑。

```mermaid
sequenceDiagram
    participant C as Client(JSON)
    participant G as Gateway
    participant M as MsgService
    participant K as Kafka
    participant X as Connect
    participant W as Client(WS Proto)

    C->>G: message JSON
    G->>M: gRPC SendMessage(proto)
    M->>M: idempotency + persist
    M->>K: publish message event(proto)
    X->>K: consume
    X->>W: WS binary push(proto envelope)
```

