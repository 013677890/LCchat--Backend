# è¡¥å……æ•°æ®ç»“æ„æ–‡æ¡£ï¼šMsg-Service ä¸ Connect-Service å…¨æ¥å£ç»“æ„

> **èŒƒå›´**ï¼š`03_æ•°æ®ç»“æ„ä¸æµè½¬é“¾è·¯å…¨è§£.md` ä»…è¦†ç›–äº† **SendMessage** çš„å®Œæ•´é“¾è·¯ã€‚  
> æœ¬æ–‡æ¡£è¡¥å…… msg-service å‰©ä½™æ¥å£ï¼ˆæ‹‰å–ã€æ’¤å›ã€ä¼šè¯ç®¡ç†ï¼‰å’Œ connect-service å…¨æ¥å£çš„æ•°æ®ç»“æ„ã€‚

---

## ä¸€ã€Msg-Service å‰©ä½™æ¥å£

---

### 1. PullMessages â€” æŒ‰ä¼šè¯å¢é‡æ‹‰å–å†å²æ¶ˆæ¯

**è°ƒç”¨é“¾è·¯**ï¼š`Client â†’ Gateway (HTTP GET) â†’ msg-service (gRPC)`

#### è¯·æ±‚ï¼ˆHTTP å±‚ï¼‰

```
GET /api/v1/auth/msg/pull?conv_id=p2p-usr_abc-usr_def&anchor_seq=40&direction=1&limit=50
Authorization: Bearer <access_token>
```

#### è¯·æ±‚ï¼ˆgRPC å±‚ï¼‰

```protobuf
// proto/msg/msg_service.proto
message PullMessagesRequest {
  string conv_id = 1;          // ç›®æ ‡ä¼šè¯ ID
  int64 anchor_seq = 2;        // é”šç‚¹ seqï¼ˆä»¥æ­¤ä¸ºåŸºå‡†æ‹‰å–å‰åæ¶ˆæ¯ï¼‰
  int32 limit = 3;             // å•æ¬¡æ‹‰å–ä¸Šé™ï¼ˆé»˜è®¤50ï¼Œæœ€å¤§200ï¼‰
  PullDirection direction = 4; // æ‹‰å–æ–¹å‘
}

enum PullDirection {
  PULL_DIRECTION_UNSPECIFIED = 0; // é»˜è®¤ç­‰åŒ FORWARD
  PULL_DIRECTION_FORWARD    = 1; // seq > anchor_seqï¼ˆæ‹‰æ–°æ¶ˆæ¯ï¼‰
  PULL_DIRECTION_BACKWARD   = 2; // seq < anchor_seqï¼ˆåŠ è½½å†å²ï¼‰
}
```

**è½¬åŒ–åŠ¨ä½œ**ï¼š
- Gateway å°† Query å‚æ•°æ˜ å°„åˆ° Proto å­—æ®µ
- Gateway ä» JWT æå– `owner_uuid`ï¼Œç”¨äºæœåŠ¡ç«¯é‰´æƒï¼ˆç¡®è®¤è¯¥ç”¨æˆ·æœ‰æƒæ‹‰å–æ­¤ä¼šè¯ï¼‰
- æœåŠ¡ç«¯å¢åŠ  `seq > clear_seq` è¿‡æ»¤æ¡ä»¶ï¼Œé˜²æ­¢å·²åˆ é™¤ä¼šè¯çš„å†å²æ¶ˆæ¯"å¹½çµå¤æ´»"

#### å“åº”ï¼ˆgRPC å±‚ï¼‰

```protobuf
message PullMessagesResponse {
  repeated MsgItem messages = 1; // æŒ‰ seq å‡åºæ’åˆ—çš„æ¶ˆæ¯åˆ—è¡¨
  bool has_more = 2;             // æ˜¯å¦è¿˜æœ‰æ›´å¤šå¯æ‹‰å–
  int64 max_seq = 3;             // è¯¥ä¼šè¯å½“å‰æœ€å¤§ seqï¼ˆå®¢æˆ·ç«¯åˆ¤æ–­ gap ç”¨ï¼‰
}
```

#### å“åº”ï¼ˆHTTP å±‚ï¼‰

```json
{
  "code": 0,
  "data": {
    "messages": [
      {
        "msg_id": "01HW5K...",
        "client_msg_id": "c3f8a1b2-...",
        "conv_id": "p2p-usr_abc-usr_def",
        "seq": 41,
        "from_uuid": "usr_abc",
        "msg_type": 1,
        "content": "{\"text\":\"ä½ å¥½\"}",
        "status": 0,
        "send_time": 1740391200000,
        "reply_to_msg_id": "",
        "at_users": []
      }
    ],
    "has_more": false,
    "max_seq": 42
  },
  "timestamp": 1740391200000
}
```

**MsgItem â†’ JSON è½¬åŒ–**ï¼šProto çš„ `MsgItem` å„å­—æ®µç›´æ¥æ˜ å°„ä¸º JSON çš„ camelCase/snake_case å­—æ®µã€‚`at_users`ï¼ˆrepeated stringï¼‰æ˜ å°„ä¸º JSON æ•°ç»„ã€‚

---

### 2. GetMessagesByIds â€” æ‰¹é‡æŒ‰ ID æŸ¥è¯¢æ¶ˆæ¯

**è°ƒç”¨é“¾è·¯**ï¼š`Client â†’ Gateway (HTTP POST) â†’ msg-service (gRPC)`

#### è¯·æ±‚ï¼ˆgRPC å±‚ï¼‰

```protobuf
message GetMessagesByIdsRequest {
  string conv_id = 1;          // ä¼šè¯ IDï¼ˆç”¨äºå®šä½åˆ†è¡¨/ç´¢å¼•ï¼‰
  repeated string msg_ids = 2; // è¦æŸ¥è¯¢çš„æ¶ˆæ¯ ID åˆ—è¡¨ï¼ˆ1~50 æ¡ï¼‰
}
```

#### å“åº”ï¼ˆgRPC å±‚ï¼‰

```protobuf
message GetMessagesByIdsResponse {
  repeated MsgItem messages = 1; // æŸ¥åˆ°çš„æ¶ˆæ¯ï¼ˆé¡ºåºä¸ä¿è¯ï¼Œæ‰¾ä¸åˆ°çš„é™é»˜è·³è¿‡ï¼‰
}
```

**å…¸å‹åœºæ™¯**ï¼š
- ç”¨æˆ·ç‚¹å‡»å¼•ç”¨/å›å¤åŒºåŸŸï¼Œéœ€è·³è½¬åˆ°åŸå§‹æ¶ˆæ¯
- æ¨é€é€šçŸ¥åªæºå¸¦ `msg_id`ï¼Œå®¢æˆ·ç«¯éœ€åæŸ¥è¯¦æƒ…

---

### 3. RecallMessage â€” æ¶ˆæ¯æ’¤å›

**è°ƒç”¨é“¾è·¯**ï¼š`Client â†’ Gateway (HTTP POST) â†’ msg-service (gRPC) â†’ Kafka â†’ Connect â†’ Client`

#### è¯·æ±‚ï¼ˆHTTP å±‚ï¼‰

```json
{
  "conv_id": "p2p-usr_abc-usr_def",
  "msg_id": "01HW5K9Q1ZBXK3EJGA7MKYQ4XT"
}
```

> `operator_uuid` ä¸åœ¨è¯·æ±‚ä½“ä¸­ï¼Œç”± Gateway ä» JWT æå–åæ³¨å…¥ gRPCã€‚

#### è¯·æ±‚ï¼ˆgRPC å±‚ï¼‰

```protobuf
message RecallMessageRequest {
  string conv_id = 1;         // ä¼šè¯ ID
  string msg_id = 2;          // è¦æ’¤å›çš„æ¶ˆæ¯ ID
  string operator_uuid = 3;   // æ“ä½œè€… UUIDï¼ˆGateway æ³¨å…¥ï¼‰
}
```

**æœåŠ¡ç«¯å¤„ç†æµç¨‹**ï¼š
1. æ ¡éªŒ `operator_uuid` æ˜¯å¦ä¸ºæ¶ˆæ¯å‘é€è€…æˆ–ç¾¤ç®¡ç†å‘˜
2. æ ¡éªŒæ˜¯å¦åœ¨ 2 åˆ†é’Ÿæ’¤å›çª—å£å†…
3. æ›´æ–° DBï¼š`status=1`ï¼Œ`content` æ”¹å†™ä¸ºæ’¤å›æç¤º JSON
4. å†™ Kafkaï¼š`MsgPushEvent{ type="MSG_RECALL", data=RecallNotice }`

#### å“åº”ï¼ˆgRPC å±‚ï¼‰

```protobuf
message RecallMessageResponse {} // ç©ºå“åº”ï¼ŒæˆåŠŸå³ä»£è¡¨æ’¤å›å®Œæˆ
```

#### å¼‚æ­¥ä¸‹è¡Œæ¨é€

msg-service æ’¤å›æˆåŠŸåå†™å…¥ Kafka çš„ `MsgPushEvent`ï¼š

```
MsgPushEvent {
  type = "MSG_RECALL"
  data = RecallNotice (proto bytes) {
    conv_id     = "p2p-usr_abc-usr_def"
    msg_id      = "01HW5K..."
    operator    = "usr_abc"
    recall_time = 1740391260000
  }
}
```

Connect æ¶ˆè´¹åå°è£…ä¸º `MessageEnvelope{ type="MSG_RECALL", data=RecallNotice }` æ¨é€åˆ°ä¼šè¯å†…æ‰€æœ‰åœ¨çº¿è®¾å¤‡ã€‚å®¢æˆ·ç«¯æ”¶åˆ°åå°†å¯¹åº”æ°”æ³¡æ›¿æ¢ä¸º"æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯"ã€‚

---

## äºŒã€Msg-Service ä¼šè¯ç®¡ç†æ¥å£

---

### 4. GetConversations â€” è·å–ä¼šè¯åˆ—è¡¨

**è°ƒç”¨é“¾è·¯**ï¼š`Client â†’ Gateway (HTTP GET) â†’ msg-service (gRPC)`

#### è¯·æ±‚ï¼ˆgRPC å±‚ï¼‰

```protobuf
message GetConversationsRequest {
  string owner_uuid = 1;   // ä¼šè¯å½’å±ç”¨æˆ·ï¼ˆGateway æ³¨å…¥ï¼‰
  int64 updated_since = 2; // å¢é‡èµ·å§‹æ—¶é—´æˆ³ï¼ˆ0=å…¨é‡ï¼‰
  int32 page_size = 3;     // åˆ†é¡µå¤§å°ï¼ˆé»˜è®¤50ï¼Œä¸Šé™200ï¼‰
  int64 cursor = 4;        // åˆ†é¡µæ¸¸æ ‡ï¼ˆä¸Šä¸€é¡µæœ€åä¸€æ¡çš„ updated_atï¼‰
}
```

#### å“åº”ï¼ˆgRPC å±‚ï¼‰

```protobuf
message GetConversationsResponse {
  repeated ConversationItem conversations = 1; // ä¼šè¯åˆ—è¡¨ï¼ˆæŒ‰ updated_at å€’åºï¼‰
  bool has_more = 2;
  int64 next_cursor = 3; // ç»å¯¹ä¸èƒ½è¿”å› 0ï¼Œå¿…é¡»å–åˆ—è¡¨ä¸­æœ€å¤§ updated_at
}
```

#### `ConversationItem` ç»“æ„ï¼ˆgRPC â†’ JSON æ˜ å°„ï¼‰

```protobuf
message ConversationItem {
  string conv_id = 1;       // â†’ "conv_id"
  ConvType conv_type = 2;   // â†’ "conv_type" (1=å•èŠ 2=ç¾¤èŠ)
  string target_uuid = 3;   // â†’ "target_uuid"
  MsgItem last_msg = 4;     // â†’ "last_msg" (åµŒå¥—å¯¹è±¡ï¼Œå¯ä¸ºç©º)
  int32 unread_count = 5;   // â†’ "unread_count"
  bool mute = 6;            // â†’ "mute"
  bool pin = 7;             // â†’ "pin"
  int64 updated_at = 8;     // â†’ "updated_at"ï¼ˆç”¨äºæ¸¸æ ‡åˆ†é¡µï¼‰
  string last_msg_sender_name = 9;   // â†’ "last_msg_sender_name"ï¼ˆå¿«ç…§ï¼‰
  string last_msg_sender_avatar = 10; // â†’ "last_msg_sender_avatar"ï¼ˆå¿«ç…§ï¼‰
}
```

**è½¬åŒ–åŠ¨ä½œ**ï¼ˆæœåŠ¡ç«¯ç”Ÿæˆ ConversationItemï¼‰ï¼š
- ä» `model.Conversation` å–åŸºç¡€å­—æ®µ
- `unread_count`ï¼šå•èŠç›´æ¥å– `max(0, max_seq - read_seq)`ï¼›ç¾¤èŠé€šè¿‡ `max(0, group.max_seq - member.read_seq)` åŠ¨æ€è®¡ç®—
- `last_msg`ï¼šé€šè¿‡ `last_msg_id` å…³è”æŸ¥è¯¢ `Message` è¡¨ï¼Œè½¬ä¸º `MsgItem`
- `last_msg_sender_name/avatar`ï¼šå¿«ç…§å­—æ®µï¼Œç”¨æˆ·æ”¹ååä¸å›å†™å†å²

---

### 5. MarkRead â€” æ ‡è®°å·²è¯»

**è°ƒç”¨é“¾è·¯**ï¼š`Client â†’ Gateway (HTTP POST) â†’ msg-service (gRPC) â†’ Kafka â†’ Connectï¼ˆå¤šç«¯åŒæ­¥ï¼‰`

#### è¯·æ±‚ï¼ˆgRPC å±‚ï¼‰

```protobuf
message MarkReadRequest {
  string conv_id = 1;     // ä¼šè¯ ID
  string owner_uuid = 2;  // å½’å±ç”¨æˆ·ï¼ˆGateway æ³¨å…¥ï¼‰
  int64 read_seq = 3;     // å®¢æˆ·ç«¯å·²è¯»åˆ°çš„æœ€å¤§ seqï¼ˆ> 0ï¼‰
}
```

#### å“åº”ï¼ˆgRPC å±‚ï¼‰

```protobuf
message MarkReadResponse {
  int32 unread_count = 1;
  // ç”± max(0, conv.max_seq - read_seq) åŠ¨æ€è®¡ç®—ï¼Œ
  // å¹¶å‘æ–°æ¶ˆæ¯æ’å…¥æ—¶å¯èƒ½å¤§äº 0
}
```

**æœåŠ¡ç«¯å¤„ç†**ï¼š
1. `read_seq = max(DB.read_seq, req.read_seq)`ï¼ˆå•è°ƒé€’å¢ï¼‰
2. è®¡ç®— `unread_count = max(0, max_seq - read_seq)`
3. å†™ Kafkaï¼š`MsgPushEvent{ type="MSG_MARK_READ", data=MarkReadNotice }` â†’ å¤šç«¯åŒæ­¥

#### å¼‚æ­¥ä¸‹è¡Œæ¨é€ï¼ˆå¤šç«¯åŒæ­¥ï¼‰

```
MsgPushEvent {
  type = "MSG_MARK_READ"
  data = MarkReadNotice (proto bytes) {
    conv_id  = "p2p-usr_abc-usr_def"
    read_seq = 42
  }
}
```

Connect æ¶ˆè´¹åæ¨é€ç»™è¯¥ç”¨æˆ·çš„**å…¶ä»–åœ¨çº¿è®¾å¤‡**ï¼Œå„ç«¯æ®æ­¤æ¸…é™¤çº¢ç‚¹ã€‚

---

### 6. DeleteConversation â€” åˆ é™¤ä¼šè¯

**è°ƒç”¨é“¾è·¯**ï¼š`Client â†’ Gateway (HTTP DELETE) â†’ msg-service (gRPC)`

#### è¯·æ±‚ï¼ˆgRPC å±‚ï¼‰

```protobuf
message DeleteConversationRequest {
  string conv_id = 1;     // ä¼šè¯ ID
  string owner_uuid = 2;  // å½’å±ç”¨æˆ·ï¼ˆGateway æ³¨å…¥ï¼‰
}
```

#### å“åº”ï¼ˆgRPC å±‚ï¼‰

```protobuf
message DeleteConversationResponse {} // ç©ºå“åº”
```

**æœåŠ¡ç«¯å¤„ç†**ï¼š
1. `status = 1`ï¼ˆé€»è¾‘åˆ é™¤ï¼‰
2. `clear_seq = å½“å‰ max_seq`
3. `read_seq = max_seq`ï¼ˆæœªè¯»æ•°å½’é›¶ï¼‰
4. åç»­ PullMessages è‡ªåŠ¨åŠ  `seq > clear_seq` è¿‡æ»¤

---

### 7. UpdateConversationSettings â€” æ›´æ–°ä¼šè¯è®¾ç½®

**è°ƒç”¨é“¾è·¯**ï¼š`Client â†’ Gateway (HTTP PATCH) â†’ msg-service (gRPC)`

#### è¯·æ±‚ï¼ˆgRPC å±‚ï¼‰

```protobuf
message UpdateConvSettingsRequest {
  string conv_id = 1;       // ä¼šè¯ ID
  string owner_uuid = 2;    // å½’å±ç”¨æˆ·ï¼ˆGateway æ³¨å…¥ï¼‰
  optional bool mute = 3;   // å…æ‰“æ‰°ï¼ˆä»…ä¼ éœ€è¦ä¿®æ”¹çš„ï¼‰
  optional bool pin = 4;    // ç½®é¡¶ï¼ˆä»…ä¼ éœ€è¦ä¿®æ”¹çš„ï¼‰
}
```

#### å“åº”ï¼ˆgRPC å±‚ï¼‰

```protobuf
message UpdateConvSettingsResponse {} // ç©ºå“åº”
```

**optional è¯­ä¹‰**ï¼šProto3 `optional` ä¿è¯æœªä¼ å…¥çš„å­—æ®µä¸ä¼šè¢«è¦†ç›–ï¼Œåªæ›´æ–°æœ‰å€¼çš„å­—æ®µã€‚

---

## ä¸‰ã€Connect-Service äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆæ— å¤´æœåŠ¡ï¼‰

> **ğŸ§¨ æ¶æ„é‡æ„è­¦ç¤ºï¼ˆè§£å†³ Stateful æ‚–è®ºï¼‰**ï¼š
> Connect-Service ç®¡ç†é•¿è¿æ¥ï¼Œæœ¬è´¨æ˜¯**æœ‰çŠ¶æ€çš„ï¼ˆStatefulï¼‰**çš„èŠ‚ç‚¹ã€‚å¦‚æœæš´éœ²ä¼ ç»Ÿçš„åŸºäºè´Ÿè½½å‡è¡¡çš„ gRPC æ¥å£ï¼ˆå¦‚è¸¢äººã€æŸ¥è¯¢çŠ¶æ€ï¼‰ï¼Œç”±äºä¸Šæ¸¸æ— æ³•é¢„çŸ¥ç›®æ ‡ç”¨æˆ·å…·ä½“å¤„äº N å° Connect èŠ‚ç‚¹ä¸­çš„å“ªä¸€å°ï¼Œä¼šå¯¼è‡´ 90% çš„ RPC è¯·æ±‚å‘½ä¸­åˆ°æ²¡æœ‰ç»‘å®šè¯¥ç”¨æˆ·çš„èŠ‚ç‚¹ï¼Œå¯¼è‡´æ“ä½œå¤±æ•ˆï¼ˆè¸¢äººæ²¡è¸¢æ‰ï¼‰ã€‚
> **æœ€æ–°æ¶æ„æ¼”è¿›**ğŸ”¥ï¼šConnect-Service **ä¸å†å¯¹å¤–æä¾›ä»»ä½• RPC/gRPC æ¥å£**ï¼Œå½»åº•å˜ä¸ºâ€œæ— å¤´ï¼ˆHeadlessï¼‰â€çš„äº‹ä»¶æ¶ˆè´¹èŠ‚ç‚¹ï¼æ‰€æœ‰è¢«åŠ¨äº¤äº’ä¸€å¾‹èµ° Redis Pub/Subï¼ˆäº‹ä»¶å¹¿æ’­ï¼‰ä¸ Redis å…±äº«å­˜å‚¨ï¼ˆåœ¨çº¿çŠ¶æ€ï¼‰ã€‚

---

### 8. KickEvent â€” åŸºäº Pub/Sub çš„è¸¢çº¿æœºåˆ¶

**æ‚–è®ºåœºæ™¯**ï¼šå¼ ä¸‰åœ¨ Node-A ä¸Šçº¿ï¼Œå¦‚æœ User-Service è°ƒç”¨ gRPC æ‰“åˆ°äº† Node-Bï¼ŒNode-B æ‰¾ä¸åˆ°å¼ ä¸‰ï¼Œè¸¢äººå¤±è´¥ã€‚  
**äº‹ä»¶é©±åŠ¨è§£æ³•**ï¼šUser-Service å‘é€ `KickEvent` åˆ° Redis Pub/Sub é›†ç¾¤ï¼Œ**æ‰€æœ‰** Connect èŠ‚ç‚¹åŒæ—¶æ”¶åˆ°å¹¿æ’­ã€‚æ²¡æœ‰å¼ ä¸‰çš„èŠ‚ç‚¹å¿½ç•¥ï¼Œæœ‰å¼ ä¸‰çš„ Node-A å‘½ä¸­å¹¶ææ–­ WebSocketã€‚

**ä»‹è´¨**ï¼š`Redis Pub/Sub Topic: connect:events:kick`

```protobuf
message KickEvent {
  string user_uuid = 1; // ç›®æ ‡ç”¨æˆ· UUID
  string device_id = 2; // ç›®æ ‡è®¾å¤‡ IDï¼ˆå¦‚éœ€å‰”é™¤å…¨ç«¯å¯ä¼ ç‰¹æ®Šå€¼ "ALL"ï¼‰
  string reason = 3;    // è¸¢çº¿åŸå› ï¼ˆå®¢æˆ·ç«¯å¯æ®æ­¤æç¤ºç”¨æˆ·å¸å·è¢«å°/å¼‚åœ°ç™»å½•ï¼‰
}
```

**ä¸‹è¡Œååº”**ï¼šå‘½ä¸­ç”¨æˆ·çš„ Connect èŠ‚ç‚¹ï¼Œåœ¨ææ–­ TCP ä¹‹å‰ï¼Œå‘è¢«è¸¢è®¾å¤‡ä¸‹å‘ `MessageEnvelope{ type="KICKOUT", data={reason} }` å¸§ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åè·³è½¬ç™»å½•é¡µã€‚

---

### 9. BroadcastEvent â€” å…¨æœ/æ‰¹é‡ç³»ç»Ÿçº§å¹¿æ’­

**ä»‹è´¨**ï¼š`Redis Pub/Sub Topic: connect:events:broadcast`

> **æ³¨æ„**ï¼šèŠå¤©æ¶ˆæ¯ä¸‹å‘èµ°ä¸“æœ‰ Kafkaï¼ˆ`MsgPushEvent`ï¼‰ï¼Œæ­¤æ¥å£ä»…é€‚ç”¨äºä½é¢‘ã€é€šç”¨çš„ç³»ç»Ÿçº§å¹¿æ’­ï¼ˆå¦‚ç³»ç»Ÿç»´æŠ¤å…¬å‘Šï¼‰ã€‚

```protobuf
message BroadcastEvent {
  // ç›®æ ‡ç”¨æˆ· UUID åˆ—è¡¨ã€‚è‹¥ä¸ºç©ºï¼Œè¡¨ç¤ºå‘å…¨æœï¼ˆå½“å‰èŠ‚ç‚¹ç»´æŠ¤çš„æ‰€æœ‰è¿æ¥ï¼‰å¹¿æ’­
  repeated string user_uuids = 1; 
  // æŠ•é€’çš„å…·ä½“æ¶ˆæ¯ä½“
  MessageEnvelope message = 2;    
}
```

**è¿è¡Œé€»è¾‘**ï¼šå…¨éƒ¨ Connect èŠ‚ç‚¹æ”¶åˆ°æ­¤äº‹ä»¶åï¼Œè½®è¯¢è‡ªèº«ä¿å­˜çš„ç”¨æˆ·è¿æ¥æ± ï¼Œå¦‚æœåœ¨è‡ªå·±èŠ‚ç‚¹ä¸Šæ‰¾åˆ°äº†åˆ—è¡¨ä¸­çš„ `user_uuid`ï¼Œåˆ™ä¸ºå…¶æ‹·è´ä¸‹å‘ `message`ï¼›å¦‚æœ `user_uuids` ä¸ºç©ºï¼Œåˆ™æ— è„‘å‘è¿æ¥æ± ä¸­æ‰€æœ‰å­˜æ´»çš„ Socket å‘é€ã€‚

---

### 10. å…¨å±€ç»Ÿä¸€åœ¨çº¿çŠ¶æ€ï¼ˆRedis ZSet å”¯ä¸€çœŸç†ï¼‰

**é‡å¤§æ¶æ„è°ƒæ•´**ï¼šæˆ‘ä»¬**åˆ é™¤**äº†ä¹‹å‰ç”± Connect æš´éœ²çš„ `GetOnlineStatus` gRPC æ¥å£ï¼ä»»ä½•äººæƒ³æŸ¥è¯¢å¼ ä¸‰åœ¨ä¸åœ¨çº¿ï¼Œä¸å†å»é—® Connect æœåŠ¡ï¼Œè€Œæ˜¯ç›´æ¥æŸ¥è¯¢ç¼“å­˜ã€‚

**å”¯ä¸€çœŸç†æ¥æº**ï¼š
ç”¨æˆ·åœ¨å»ºç«‹ WebSocket æˆ–å‘é€ Heartbeat æ—¶ï¼ŒConnect èŠ‚ç‚¹å‘ Redis æ‰§è¡Œæ›´æ–°ï¼Œç»´æŠ¤ç€å…¨å±€å¯é çš„åœ¨çº¿å­—å…¸ï¼š

```redis
// Key è®¾è®¡ï¼š
ZSET user:online:{user_uuid}

// å…ƒç´ (Member) = device_id
// åˆ†æ•°(Score)  = heartbeat_timestamp (æœ€ååˆ·æ–°æ—¶é—´æˆ³)
```

**æŸ¥è¯¢æ–¹å¼ï¼ˆç»•è¿‡ Connectï¼‰**ï¼š
- **Msg-Service æŸ¥è¯¢å•èŠæ–¹æ˜¯å¦åœ¨çº¿ï¼ˆå†³å®šèµ° APNs è¿˜æ˜¯åœ¨çº¿æ¨ï¼‰**ï¼š
  ç›´æ¥æ‰§è¡Œ `ZCOUNT user:online:{receiver_uuid} <æœ‰æ•ˆå¿ƒè·³è¾¹ç•Œæ—¶é—´æˆ³> +inf`ã€‚è¿”å›å€¼ > 0 è¡¨ç¤ºèµ·ç æœ‰ä¸€ç«¯åœ¨çº¿ã€‚
- **ä¸šåŠ¡æŸ¥è¯¢æ‰¹é‡åœ¨çº¿çŠ¶æ€ï¼ˆå¦‚å¥½å‹åˆ—è¡¨ç¯æ³¡ï¼‰**ï¼š
  ä¸šåŠ¡ç³»ç»Ÿç›´æ¥å°è£… Lua è„šæœ¬æˆ– Pipelined å¤šæ¡ ZCOUNT å¯¹ Redis å‘èµ·é«˜é€Ÿè¯»å–ã€‚

æ‰€æœ‰ Connect ä¸‹è¡Œæ¨é€çš„æœ€ç»ˆè½½ä½“ï¼Œå®¢æˆ·ç«¯è§£ç çš„å…¥å£ç»“æ„ï¼š

```protobuf
// proto/connect/connect.proto
message MessageEnvelope {
  string type = 1;       // æ¶ˆæ¯ç±»å‹è·¯ç”±é”®
  bytes data = 2;        // ä¸šåŠ¡è´Ÿè½½ï¼ˆæŒ‰ type ååºåˆ—åŒ–ï¼‰
  int64 seq = 3;         // æ¶ˆæ¯åºåˆ—å·ï¼ˆå®¢æˆ·ç«¯å»é‡/æ’åºï¼‰
  int64 server_ts = 4;   // æœåŠ¡ç«¯æ—¶é—´æˆ³ï¼ˆunix æ¯«ç§’ï¼‰
  string trace_id = 5;   // é“¾è·¯è¿½è¸ª ID
  bool ack_required = 6; // æ˜¯å¦éœ€è¦å®¢æˆ·ç«¯å›æ‰§
}
```

**type è·¯ç”±è¡¨**ï¼š

| type å€¼ | data è§£ç ä¸º | å®¢æˆ·ç«¯åŠ¨ä½œ |
|---------|-----------|-----------|
| `MSG_PUSH` | `MsgItem` | æ¸²æŸ“æ¶ˆæ¯æ°”æ³¡ |
| `MSG_RECALL` | `RecallNotice` | æ›¿æ¢æ°”æ³¡ä¸º"æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯" |
| `MSG_MARK_READ` | `MarkReadNotice` | åŒæ­¥æ¸…é™¤çº¢ç‚¹ |
| `KICKOUT` | æ— ï¼ˆæˆ–åŒ…å« reasonï¼‰ | è·³è½¬ç™»å½•é¡µ |

---

## å››ã€é€šç”¨æšä¸¾ä¸æ•°æ®ç±»å‹é€ŸæŸ¥

### ConvType â€” ä¼šè¯ç±»å‹

```protobuf
enum ConvType {
  CONV_TYPE_UNSPECIFIED = 0; // æœªæŒ‡å®š
  CONV_TYPE_P2P         = 1; // å•èŠ
  CONV_TYPE_GROUP       = 2; // ç¾¤èŠ
}
```

### MsgItem â€” æ¶ˆæ¯å®Œæ•´ç»“æ„ï¼ˆè·¨å¤šæ¥å£å¤ç”¨ï¼‰

```protobuf
message MsgItem {
  string msg_id = 1;             // å…¨å±€å”¯ä¸€æ¶ˆæ¯ ID
  string client_msg_id = 2;      // å®¢æˆ·ç«¯å¹‚ç­‰ ID
  string conv_id = 3;            // æ‰€å±ä¼šè¯ ID
  int64 seq = 4;                 // ä¼šè¯å†…ä¸¥æ ¼é€’å¢åºå·
  string from_uuid = 5;          // å‘é€è€… UUID
  int32 msg_type = 6;            // æ¶ˆæ¯ç±»å‹ï¼ˆ0-99 æ™®é€šï¼Œ100+ ç³»ç»Ÿï¼‰
  string content = 7;            // æ¶ˆæ¯å†…å®¹ JSON
  int32 status = 8;              // 0=æ­£å¸¸ 1=æ’¤å› 2=åˆ é™¤
  int64 send_time = 9;           // å‘é€æ—¶é—´ï¼ˆunix æ¯«ç§’ï¼‰
  string reply_to_msg_id = 10;   // å¼•ç”¨å›å¤çš„ç›®æ ‡æ¶ˆæ¯ ID
  repeated string at_users = 11; // è¢«@ç”¨æˆ· UUID åˆ—è¡¨
}
```

**å¤ç”¨åœºæ™¯**ï¼š
- `SendMessage` è½åº“åè½¬ä¸º `MsgItem` å†™å…¥ Kafka
- `PullMessages` / `GetMessagesByIds` å“åº”ä¸­è¿”å›
- `MessageEnvelope` çš„ `data` å­—æ®µè§£ç åå¾—åˆ°
- `ConversationItem.last_msg` åµŒå¥—å¼•ç”¨
